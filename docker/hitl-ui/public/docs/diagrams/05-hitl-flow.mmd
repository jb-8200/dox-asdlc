%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#E6F0FF'}}}%%

flowchart TD
    subgraph AgentPhase["Agent Execution"]
        Agent["Agent Container\n(Claude Code CLI)"]
        Complete["Phase Complete\nArtifacts Ready"]
    end

    subgraph CoordCheck["Coordinator Check"]
        Receive["Receive\nPhaseCompleted"]
        CheckWF{"Check WORKFLOW:\ntransition type?"}
    end

    subgraph HITLFlow["HITL Flow"]
        PublishReq["Publish to\nasdlc:hitl:requests"]
        Gateway["HITL Gateway\n(FastAPI)"]
        SPA["SPA UI\n(Next.js)"]
        HumanReview{"Human\nReview"}
        PublishDecision["Publish to\nasdlc:hitl:decisions"]
    end

    subgraph Outcomes["Outcomes"]
        Approved["GateApproved\n→ Spawn Next Phase"]
        Rejected["GateRejected\n→ Retry with Feedback"]
        SpawnNext["Coordinator:\nk8s.create_job(\n  next_phase\n)"]
        SpawnRetry["Coordinator:\nk8s.create_job(\n  same_phase,\n  feedback\n)"]
    end

    %% Main flow
    Agent --> Complete
    Complete -->|xadd PhaseCompleted| Receive
    Receive --> CheckWF

    CheckWF -->|AUTO| SpawnNext
    CheckWF -->|HITL| PublishReq

    PublishReq -->|xread| Gateway
    Gateway -->|WebSocket| SPA
    SPA --> HumanReview

    HumanReview -->|Approve| Approved
    HumanReview -->|Reject| Rejected
    HumanReview -->|Comment| SPA

    Approved -->|xadd| PublishDecision
    Rejected -->|xadd| PublishDecision

    PublishDecision -->|GateApproved| SpawnNext
    PublishDecision -->|GateRejected| SpawnRetry

    SpawnNext --> NextAgent["Next Phase\nAgent Container"]
    SpawnRetry --> RetryAgent["Same Phase\nAgent Container\n(with feedback)"]

    %% Styling
    classDef agent fill:#E6F0FF,stroke:#2563eb,stroke-width:2px
    classDef coord fill:#D0E8FF,stroke:#0b1559,stroke-width:2px
    classDef hitl fill:#FFF7ED,stroke:#EA580C,stroke-width:2px
    classDef decision fill:#FEF3C7,stroke:#d97706,stroke-width:2px
    classDef outcome fill:#DCFCE7,stroke:#16a34a,stroke-width:2px
    classDef reject fill:#FEE2E2,stroke:#dc2626,stroke-width:2px

    class Agent,Complete,NextAgent,RetryAgent agent
    class Receive,CheckWF,SpawnNext,SpawnRetry coord
    class PublishReq,Gateway,SPA,PublishDecision hitl
    class HumanReview decision
    class Approved outcome
    class Rejected reject
