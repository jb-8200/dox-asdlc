%% File: docs/diagrams/20-service-health-dashboard.mmd
%% Description: Service Health Dashboard architecture showing topology and data flow (P06-F07)
%% Updated: 2026-01-27

%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#E6F0FF', 'primaryTextColor': '#1e3a5f', 'primaryBorderColor': '#2563eb', 'lineColor': '#64748b'}}}%%

flowchart TB
    subgraph Dashboard["ServiceHealthDashboard Component"]
        subgraph TopologySection["Service Topology Map"]
            HITLUI["ðŸŸ¢ HITL-UI\n(healthy)"]
            Orchestrator["ðŸŸ¢ Orchestrator\n(healthy)"]
            Workers["ðŸŸ¡ Workers\n(degraded)"]
            Redis["ðŸŸ¢ Redis\n(healthy)"]
            ES["ðŸŸ¢ Elasticsearch\n(healthy)"]

            HITLUI -->|HTTP| Orchestrator
            Orchestrator -->|HTTP| Workers
            Orchestrator -->|Redis| Redis
            Workers -->|Redis| Redis
            Orchestrator -->|ES| ES
            Workers -->|ES| ES
        end

        subgraph CardsGrid["Service Cards Grid"]
            Card1["ServiceCard: HITL-UI\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ CPU: â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆ  â”‚\nâ”‚ Mem: â–‚â–‚â–ƒâ–ƒâ–„â–„â–…â–…  â”‚\nâ”‚ 12 req/s, 15ms â”‚\nâ”‚ 2 pods         â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"]
            Card2["ServiceCard: Orchestrator\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ CPU: â–ƒâ–„â–…â–†â–‡â–‡â–†â–…  â”‚\nâ”‚ Mem: â–…â–…â–†â–†â–†â–‡â–‡â–‡  â”‚\nâ”‚ 45 req/s, 8ms  â”‚\nâ”‚ 3 pods         â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"]
            Card3["ServiceCard: Workers\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ CPU: â–‡â–‡â–†â–…â–„â–ƒâ–‚â–  â”‚\nâ”‚ Mem: â–†â–†â–‡â–‡â–‡â–‡â–‡â–‡  â”‚\nâ”‚ 3 active tasks â”‚\nâ”‚ 5 pods         â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"]
            Card4["ServiceCard: Redis\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ CPU: â–‚â–‚â–‚â–ƒâ–ƒâ–‚â–‚â–‚  â”‚\nâ”‚ Mem: â–„â–„â–„â–„â–„â–„â–„â–„  â”‚\nâ”‚ 45 connections â”‚\nâ”‚ 1 pod          â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"]
            Card5["ServiceCard: ES\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ CPU: â–ƒâ–ƒâ–„â–„â–…â–…â–†â–†  â”‚\nâ”‚ Mem: â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡  â”‚\nâ”‚ 3 indices      â”‚\nâ”‚ 1 pod          â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"]
        end
    end

    subgraph Backend["Backend API Layer"]
        HealthEndpoint["/api/metrics/services/health\nReturns: ServiceHealthInfo[]\nâ€¢ name, status, cpu, memory\nâ€¢ podCount, requestRate, latencyP50"]
        SparklineEndpoint["/api/metrics/services/{name}/sparkline\nReturns: SparklineDataPoint[]\nâ€¢ 15 minutes history\nâ€¢ 1-minute intervals"]
        ServiceHealthSvc["ServiceHealthService\nâ€¢ Aggregates VM metrics\nâ€¢ Determines health status\nâ€¢ Caches results (5min TTL)"]
    end

    subgraph DataSources["Data Sources"]
        VM["VictoriaMetrics\nâ€¢ process_cpu_seconds_total\nâ€¢ process_resident_memory_bytes\nâ€¢ http_requests_total\nâ€¢ http_request_duration_seconds"]
    end

    %% Data flow
    Dashboard -->|"useServicesHealth()\n30s refresh"| HealthEndpoint
    Dashboard -->|"useServiceSparkline()\n1min refresh"| SparklineEndpoint
    HealthEndpoint --> ServiceHealthSvc
    SparklineEndpoint --> ServiceHealthSvc
    ServiceHealthSvc -->|PromQL queries| VM

    %% Styling
    classDef ui fill:#E0F2FE,stroke:#0284c7,stroke-width:2px
    classDef backend fill:#D0E8FF,stroke:#2563eb,stroke-width:2px
    classDef datasource fill:#DCFCE7,stroke:#16a34a,stroke-width:2px
    classDef healthy fill:#DCFCE7,stroke:#16a34a,stroke-width:2px
    classDef degraded fill:#FEF3C7,stroke:#d97706,stroke-width:2px

    class Dashboard,TopologySection,CardsGrid ui
    class HealthEndpoint,SparklineEndpoint,ServiceHealthSvc backend
    class VM datasource
    class HITLUI,Orchestrator,Redis,ES healthy
    class Workers degraded
