# aSDLC Docker Compose - Multi Container Topology
# See docs/System_Design.md Section 4.1 for architecture details

services:
  # Container 0: PostgreSQL Database
  # - Persistent storage for ideation sessions and related data
  # - Used by orchestrator for persistence layer
  postgres:
    image: postgres:16-alpine
    container_name: asdlc-postgres
    hostname: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-asdlc_ideation}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB:-asdlc_ideation}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - asdlc-network

  # Container 1: Orchestrator and Governance
  # - Exclusive Git write access to protected branches
  # - Runs Manager Agent and governance services
  # - Consumes Redis Streams and dispatches work
  orchestrator:
    build:
      context: ..
      dockerfile: docker/orchestrator/Dockerfile
    container_name: asdlc-orchestrator
    hostname: orchestrator
    ports:
      - "8080:8080"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=changeme_redis_password_before_deployment
      - REDIS_URL=redis://:changeme_redis_password_before_deployment@redis:6379
      - SERVICE_NAME=orchestrator
      - SERVICE_PORT=8080
      - GIT_WRITE_ACCESS=true
      - KNOWLEDGE_STORE_BACKEND=elasticsearch
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      # Stable encryption key for API key storage (survives container restarts)
      - LLM_CONFIG_ENCRYPTION_KEY=za4k9itJgd8wPic7VjUuXlhsj0yBqGNnA81dPJbZ57s=
      # PostgreSQL persistence layer configuration
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-asdlc_ideation}
      - POSTGRES_USER=${POSTGRES_USER:?POSTGRES_USER is required}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - IDEATION_PERSISTENCE_BACKEND=postgres
      - POSTGRES_SSL_MODE=prefer
    volumes:
      - ../:/app/workspace:rw
      - git-credentials:/app/.git-credentials:ro
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - asdlc-network

  # Container 2: Agent Workers
  # - Stateless worker pool running Claude Agent SDK queries
  # - No protected branch write access
  # - Read-only workspace access
  workers:
    build:
      context: ..
      dockerfile: docker/workers/Dockerfile
    container_name: asdlc-workers
    hostname: workers
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=changeme_redis_password_before_deployment
      - SERVICE_NAME=workers
      - SERVICE_PORT=8081
      - GIT_WRITE_ACCESS=false
      - KNOWLEDGE_STORE_BACKEND=elasticsearch
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    volumes:
      - ../:/app/workspace:ro
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - asdlc-network

  # Container 2b: Review Swarm
  # - Parallel code review using Claude SDK
  # - 3 specialized reviewers (security, performance, style)
  # - Stores sessions and results in Redis
  review-swarm:
    build:
      context: ..
      dockerfile: docker/review-swarm/Dockerfile
    container_name: asdlc-review-swarm
    hostname: review-swarm
    ports:
      - "8082:8082"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=changeme_redis_password_before_deployment
      - SERVICE_NAME=review-swarm
      - SERVICE_PORT=8082
      - GIT_WRITE_ACCESS=false
      - KNOWLEDGE_STORE_BACKEND=elasticsearch
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      - ../:/app/workspace:ro
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - asdlc-network

  # Container 3: Redis
  # - Event streams and task state caches
  redis:
    build:
      context: ..
      dockerfile: docker/infrastructure/Dockerfile
    container_name: asdlc-redis
    hostname: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "changeme_redis_password_before_deployment", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - asdlc-network

  # Container 3b: Elasticsearch Knowledge Store
  # - Vector database for RAG and semantic search
  # - Stores document embeddings with kNN search
  # - Replaces ChromaDB as the default backend
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
    container_name: asdlc-elasticsearch
    hostname: elasticsearch
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - cluster.name=asdlc-cluster
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - asdlc-network

  # Container 3c: VictoriaMetrics Time Series Database
  # - Prometheus-compatible metrics storage
  # - Stores aSDLC service metrics for monitoring
  # - Query API for dashboards and alerting
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.106.1
    container_name: asdlc-victoriametrics
    hostname: victoriametrics
    ports:
      - "8428:8428"
    command:
      - -storageDataPath=/victoria-metrics-data
      - -retentionPeriod=30d
      - -promscrape.config=/scrape.yml
    volumes:
      - victoriametrics-data:/victoria-metrics-data
      - ./victoriametrics/scrape.yml:/scrape.yml:ro
    depends_on:
      - orchestrator
      - workers
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8428/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - asdlc-network

  # Container 5: Slack HITL Bridge
  # - Gate notifications to Slack channels
  # - Decision capture via Slack button interactions
  # - Ideas ingestion from Slack messages/reactions
  slack-bridge:
    build:
      context: ..
      dockerfile: docker/slack-bridge/Dockerfile
    container_name: asdlc-slack-bridge
    hostname: slack-bridge
    ports:
      - "8085:8085"
    environment:
      - REDIS_URL=redis://:changeme_redis_password_before_deployment@redis:6379
      - SERVICE_NAME=slack-bridge
      - HEALTH_PORT=8085
      # Secrets backend configuration - use GCP with Infisical cache
      - SECRETS_BACKEND=gcp
      - GCP_PROJECT_ID=gen-lang-client-0879716971
      - SECRETS_ENVIRONMENT=prod
      # Fallback: Slack credentials from env (used if secrets backend fails)
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN:-}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET:-}
      # Optional: JSON config file path for routing policy and RBAC
      - SLACK_CONFIG_FILE=${SLACK_CONFIG_FILE:-}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/gcp-credentials.json
    volumes:
      # Mount GCP credentials for Secret Manager access
      - ${HOME}/.config/gcloud/application_default_credentials.json:/app/gcp-credentials.json:ro
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - asdlc-network
    # Service is disabled by default - enable with profile or explicit start
    profiles:
      - slack

  # Container 4: HITL Web UI
  # - Gate request viewer and evidence explorer
  # - Approval pushes responses back to Redis Streams
  hitl-ui:
    build:
      context: ..
      dockerfile: docker/hitl-ui/Dockerfile
      args:
        - VITE_USE_MOCKS=true
    container_name: asdlc-hitl-ui
    hostname: hitl-ui
    ports:
      - "3000:3000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=changeme_redis_password_before_deployment
      - SERVICE_NAME=hitl-ui
      - SERVICE_PORT=3000
      - API_BACKEND_URL=http://orchestrator:8080
    depends_on:
      redis:
        condition: service_healthy
      orchestrator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - asdlc-network

  # Container 6: Infisical Secrets Manager
  # - Centralized secrets storage for all services
  # - Web UI for secret management
  # - API for programmatic access
  infisical:
    image: infisical/infisical:latest
    container_name: asdlc-infisical
    hostname: infisical
    ports:
      - "8086:8080"
    environment:
      - ENCRYPTION_KEY=${INFISICAL_ENCRYPTION_KEY:-}
      - AUTH_SECRET=${INFISICAL_AUTH_SECRET:-}
      - POSTGRES_HOST=infisical-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=infisical
      - POSTGRES_USER=infisical
      - POSTGRES_PASSWORD=${INFISICAL_DB_PASSWORD:-infisical_dev_password}
      - REDIS_URL=redis://infisical-redis:6379
      - SITE_URL=http://localhost:8086
    depends_on:
      infisical-db:
        condition: service_healthy
      infisical-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - asdlc-network
    profiles:
      - secrets

  infisical-db:
    image: postgres:15-alpine
    container_name: asdlc-infisical-db
    hostname: infisical-db
    environment:
      - POSTGRES_DB=infisical
      - POSTGRES_USER=infisical
      - POSTGRES_PASSWORD=${INFISICAL_DB_PASSWORD:-infisical_dev_password}
    volumes:
      - infisical-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U infisical -d infisical"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - asdlc-network
    profiles:
      - secrets

  infisical-redis:
    image: redis:7-alpine
    container_name: asdlc-infisical-redis
    hostname: infisical-redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - asdlc-network
    profiles:
      - secrets

networks:
  asdlc-network:
    driver: bridge
    name: asdlc-network

volumes:
  postgres-data:
    name: asdlc-postgres-data
  redis-data:
    name: asdlc-redis-data
  elasticsearch-data:
    name: asdlc-elasticsearch-data
  victoriametrics-data:
    name: asdlc-victoriametrics-data
  git-credentials:
    name: asdlc-git-credentials
  infisical-db-data:
    name: asdlc-infisical-db-data
