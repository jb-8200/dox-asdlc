name: Deploy to GCP Cloud Run

# Trigger: push to main, or manual dispatch
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'docker/**'
      - 'scripts/gcp/**'
      - '.github/workflows/deploy-cloud-run.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'lab'
        type: choice
        options:
          - lab
      skip_build:
        description: 'Skip Docker build (redeploy existing images)'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-cloud-run
  cancel-in-progress: false  # never cancel a running deploy

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  REGISTRY: ${{ vars.GCP_REGION || 'us-central1' }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/asdlc
  BUCKET: ${{ vars.GCP_PROJECT_ID }}-asdlc-pgdump

jobs:
  # ──────────────────────────────────────────
  # Job 1: Build and push Docker images
  # ──────────────────────────────────────────
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_build }}
    permissions:
      contents: read
      id-token: write  # for Workload Identity Federation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build all 5 images in parallel using Buildx bake
      - name: Build orchestrator
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/orchestrator/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/orchestrator:latest,${{ env.REGISTRY }}/orchestrator:${{ github.sha }}
          cache-from: type=gha,scope=orchestrator
          cache-to: type=gha,mode=max,scope=orchestrator

      - name: Build workers
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/workers/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/workers:latest,${{ env.REGISTRY }}/workers:${{ github.sha }}
          cache-from: type=gha,scope=workers
          cache-to: type=gha,mode=max,scope=workers

      - name: Build review-swarm
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/review-swarm/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/review-swarm:latest,${{ env.REGISTRY }}/review-swarm:${{ github.sha }}
          cache-from: type=gha,scope=review-swarm
          cache-to: type=gha,mode=max,scope=review-swarm

      - name: Build hitl-ui
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/hitl-ui/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/hitl-ui:latest,${{ env.REGISTRY }}/hitl-ui:${{ github.sha }}
          build-args: |
            VITE_USE_MOCKS=false
            VITE_API_BASE_URL=/api
          cache-from: type=gha,scope=hitl-ui
          cache-to: type=gha,mode=max,scope=hitl-ui

      - name: Build postgres-gcs
        uses: docker/build-push-action@v6
        with:
          context: docker/postgres-gcs
          file: docker/postgres-gcs/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/postgres-gcs:latest,${{ env.REGISTRY }}/postgres-gcs:${{ github.sha }}
          cache-from: type=gha,scope=postgres-gcs
          cache-to: type=gha,mode=max,scope=postgres-gcs

    outputs:
      image_tag: ${{ github.sha }}

  # ──────────────────────────────────────────
  # Job 2: Deploy backend (multi-container)
  # ──────────────────────────────────────────
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ always() && (needs.build.result == 'success' || inputs.skip_build) }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Resolve image tag
        id: tag
        run: |
          if [ "${{ inputs.skip_build }}" = "true" ]; then
            echo "tag=latest" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate Cloud Run service YAML
        env:
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          cat > /tmp/asdlc-backend.yaml <<'YAML'
          apiVersion: serving.knative.dev/v1
          kind: Service
          metadata:
            name: asdlc-backend
            annotations:
              run.googleapis.com/launch-stage: BETA
          spec:
            template:
              metadata:
                annotations:
                  run.googleapis.com/cpu-throttling: "false"
                  run.googleapis.com/startup-cpu-boost: "true"
                  autoscaling.knative.dev/minScale: "0"
                  autoscaling.knative.dev/maxScale: "1"
              spec:
                containerConcurrency: 80
                timeoutSeconds: 3600
                containers:
                  - name: orchestrator
                    image: REGISTRY_PLACEHOLDER/orchestrator:TAG_PLACEHOLDER
                    ports:
                      - containerPort: 8080
                    env:
                      - name: REDIS_HOST
                        value: "localhost"
                      - name: REDIS_PORT
                        value: "6379"
                      - name: REDIS_PASSWORD
                        value: "cloudrun-redis-pw"
                      - name: REDIS_URL
                        value: "redis://:cloudrun-redis-pw@localhost:6379"
                      - name: ELASTICSEARCH_URL
                        value: "http://localhost:9200"
                      - name: KNOWLEDGE_STORE_BACKEND
                        value: "elasticsearch"
                      - name: POSTGRES_HOST
                        value: "localhost"
                      - name: POSTGRES_PORT
                        value: "5432"
                      - name: POSTGRES_DB
                        value: "asdlc_ideation"
                      - name: POSTGRES_USER
                        value: "asdlc"
                      - name: POSTGRES_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            key: latest
                            name: postgres-password
                      - name: IDEATION_PERSISTENCE_BACKEND
                        value: "postgres"
                      - name: POSTGRES_SSL_MODE
                        value: "disable"
                      - name: SERVICE_NAME
                        value: "orchestrator"
                      - name: SERVICE_PORT
                        value: "8080"
                      - name: GIT_WRITE_ACCESS
                        value: "true"
                      - name: LLM_CONFIG_ENCRYPTION_KEY
                        valueFrom:
                          secretKeyRef:
                            key: latest
                            name: llm-encryption-key
                    resources:
                      limits:
                        cpu: "1"
                        memory: "512Mi"
                    startupProbe:
                      httpGet:
                        path: /health
                        port: 8080
                      initialDelaySeconds: 15
                      periodSeconds: 5
                      failureThreshold: 24
                    livenessProbe:
                      httpGet:
                        path: /health
                        port: 8080
                      periodSeconds: 30

                  - name: postgres
                    image: REGISTRY_PLACEHOLDER/postgres-gcs:TAG_PLACEHOLDER
                    env:
                      - name: POSTGRES_USER
                        value: "asdlc"
                      - name: POSTGRES_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            key: latest
                            name: postgres-password
                      - name: POSTGRES_DB
                        value: "asdlc_ideation"
                      - name: GCS_BUCKET
                        value: "BUCKET_PLACEHOLDER"
                      - name: DUMP_INTERVAL_SECONDS
                        value: "300"
                    resources:
                      limits:
                        cpu: "0.25"
                        memory: "256Mi"
                    startupProbe:
                      exec:
                        command: ["pg_isready", "-U", "asdlc"]
                      initialDelaySeconds: 5
                      periodSeconds: 2
                      failureThreshold: 30

                  - name: redis
                    image: redis:7-alpine
                    command: ["redis-server"]
                    args:
                      - "--bind"
                      - "0.0.0.0"
                      - "--port"
                      - "6379"
                      - "--requirepass"
                      - "cloudrun-redis-pw"
                      - "--maxmemory"
                      - "256mb"
                      - "--maxmemory-policy"
                      - "allkeys-lru"
                      - "--save"
                      - ""
                      - "--appendonly"
                      - "no"
                    resources:
                      limits:
                        cpu: "0.25"
                        memory: "300Mi"
                    startupProbe:
                      exec:
                        command: ["redis-cli", "-a", "cloudrun-redis-pw", "ping"]
                      periodSeconds: 2
                      failureThreshold: 15

                  - name: elasticsearch
                    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
                    env:
                      - name: discovery.type
                        value: "single-node"
                      - name: xpack.security.enabled
                        value: "false"
                      - name: ES_JAVA_OPTS
                        value: "-Xms384m -Xmx384m"
                      - name: cluster.name
                        value: "asdlc-cloudrun"
                    resources:
                      limits:
                        cpu: "0.5"
                        memory: "768Mi"
                    startupProbe:
                      httpGet:
                        path: /_cluster/health
                        port: 9200
                      initialDelaySeconds: 20
                      periodSeconds: 5
                      failureThreshold: 30

                  - name: workers
                    image: REGISTRY_PLACEHOLDER/workers:TAG_PLACEHOLDER
                    env:
                      - name: REDIS_HOST
                        value: "localhost"
                      - name: REDIS_PORT
                        value: "6379"
                      - name: REDIS_PASSWORD
                        value: "cloudrun-redis-pw"
                      - name: ELASTICSEARCH_URL
                        value: "http://localhost:9200"
                      - name: KNOWLEDGE_STORE_BACKEND
                        value: "elasticsearch"
                      - name: SERVICE_NAME
                        value: "workers"
                      - name: SERVICE_PORT
                        value: "8081"
                      - name: GIT_WRITE_ACCESS
                        value: "false"
                    resources:
                      limits:
                        cpu: "0.5"
                        memory: "512Mi"

                  - name: review-swarm
                    image: REGISTRY_PLACEHOLDER/review-swarm:TAG_PLACEHOLDER
                    env:
                      - name: REDIS_HOST
                        value: "localhost"
                      - name: REDIS_PORT
                        value: "6379"
                      - name: REDIS_PASSWORD
                        value: "cloudrun-redis-pw"
                      - name: ELASTICSEARCH_URL
                        value: "http://localhost:9200"
                      - name: KNOWLEDGE_STORE_BACKEND
                        value: "elasticsearch"
                      - name: ANTHROPIC_API_KEY
                        valueFrom:
                          secretKeyRef:
                            key: latest
                            name: anthropic-api-key
                      - name: LLM_CONFIG_ENCRYPTION_KEY
                        valueFrom:
                          secretKeyRef:
                            key: latest
                            name: llm-encryption-key
                      - name: SERVICE_NAME
                        value: "review-swarm"
                      - name: SERVICE_PORT
                        value: "8082"
                      - name: GIT_WRITE_ACCESS
                        value: "false"
                    resources:
                      limits:
                        cpu: "0.5"
                        memory: "512Mi"
          YAML

          # Replace placeholders with actual values
          sed -i "s|REGISTRY_PLACEHOLDER|${REGISTRY}|g" /tmp/asdlc-backend.yaml
          sed -i "s|TAG_PLACEHOLDER|${IMAGE_TAG}|g" /tmp/asdlc-backend.yaml
          sed -i "s|BUCKET_PLACEHOLDER|${BUCKET}|g" /tmp/asdlc-backend.yaml

          echo "--- Generated service YAML ---"
          cat /tmp/asdlc-backend.yaml

      - name: Deploy asdlc-backend
        run: |
          gcloud run services replace /tmp/asdlc-backend.yaml \
            --region="${REGION}" \
            --project="${PROJECT_ID}"

      - name: Allow unauthenticated access (demo)
        run: |
          gcloud run services add-iam-policy-binding asdlc-backend \
            --region="${REGION}" \
            --project="${PROJECT_ID}" \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --quiet || true

      - name: Get backend URL
        id: backend
        run: |
          URL=$(gcloud run services describe asdlc-backend \
            --region="${REGION}" \
            --project="${PROJECT_ID}" \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "Backend URL: ${URL}"

    outputs:
      backend_url: ${{ steps.backend.outputs.url }}

  # ──────────────────────────────────────────
  # Job 3: Deploy HITL UI
  # ──────────────────────────────────────────
  deploy-hitl-ui:
    name: Deploy HITL UI
    runs-on: ubuntu-latest
    needs: [build, deploy-backend]
    if: ${{ always() && needs.deploy-backend.result == 'success' }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Resolve image tag
        id: tag
        run: |
          if [ "${{ inputs.skip_build }}" = "true" ]; then
            echo "tag=latest" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy hitl-ui
        run: |
          gcloud run deploy hitl-ui \
            --image="${REGISTRY}/hitl-ui:${{ steps.tag.outputs.tag }}" \
            --region="${REGION}" \
            --project="${PROJECT_ID}" \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=2 \
            --concurrency=200 \
            --timeout=3600 \
            --set-env-vars="API_BACKEND_URL=${{ needs.deploy-backend.outputs.backend_url }}" \
            --set-env-vars="SERVICE_NAME=hitl-ui,SERVICE_PORT=3000" \
            --allow-unauthenticated

      - name: Get HITL UI URL
        id: frontend
        run: |
          URL=$(gcloud run services describe hitl-ui \
            --region="${REGION}" \
            --project="${PROJECT_ID}" \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "HITL UI URL: ${URL}"

    outputs:
      frontend_url: ${{ steps.frontend.outputs.url }}

  # ──────────────────────────────────────────
  # Job 4: Smoke test
  # ──────────────────────────────────────────
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-hitl-ui]
    if: ${{ always() && needs.deploy-backend.result == 'success' }}

    steps:
      - name: Wait for cold start
        run: sleep 10

      - name: Health check — backend
        run: |
          echo "Checking ${{ needs.deploy-backend.outputs.backend_url }}/health"
          # Cloud Run cold start can take 30-45s, retry with backoff
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /tmp/health.json -w '%{http_code}' \
              --max-time 60 \
              "${{ needs.deploy-backend.outputs.backend_url }}/health" || echo "000")
            if [ "${STATUS}" = "200" ]; then
              echo "Backend healthy!"
              cat /tmp/health.json | python3 -m json.tool || cat /tmp/health.json
              exit 0
            fi
            echo "Attempt ${i}: HTTP ${STATUS}, retrying in $((i * 15))s..."
            sleep $((i * 15))
          done
          echo "Backend health check failed after 5 attempts"
          exit 1

      - name: Health check — HITL UI
        if: ${{ needs.deploy-hitl-ui.outputs.frontend_url }}
        run: |
          echo "Checking ${{ needs.deploy-hitl-ui.outputs.frontend_url }}/health"
          for i in 1 2 3; do
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' \
              --max-time 30 \
              "${{ needs.deploy-hitl-ui.outputs.frontend_url }}/health" || echo "000")
            if [ "${STATUS}" = "200" ]; then
              echo "HITL UI healthy!"
              exit 0
            fi
            echo "Attempt ${i}: HTTP ${STATUS}, retrying in 10s..."
            sleep 10
          done
          echo "HITL UI health check failed"
          exit 1

      - name: Print deployment summary
        if: always()
        run: |
          echo "╔══════════════════════════════════════════════════╗"
          echo "║         aSDLC Cloud Run Deployment               ║"
          echo "╠══════════════════════════════════════════════════╣"
          echo "║ Backend:  ${{ needs.deploy-backend.outputs.backend_url }}"
          echo "║ Frontend: ${{ needs.deploy-hitl-ui.outputs.frontend_url }}"
          echo "║ Commit:   ${{ github.sha }}"
          echo "╚══════════════════════════════════════════════════╝"
